#!/bin/bash
target=${1:-/mnt/rescue}
root='UUID=c8f65da1-046a-4695-a581-05e64c7361f7'
boot='UUID=1729-49C1'
cache=/var/cache/pacman/pkg
declare -a dotfiles=(.gnupg .git* .password-store .ssh git/dotfiles)
targetuser=mattias
set -u

if [ ! -d "$target" ]; then
  echo $target is not a directory
  exit 1
fi
sudo mount "$root" "$target"
sudo mount "$boot" "${target}/boot"
sudo mount --bind "$cache" "${target}/${cache}"
if ! mount | grep -qc "$target"; then
  echo $target not mounted
  exit 1
fi
# update the most important dotfiles for recovery
echo Updating important stuff
for d in ${dotfiles[@]}; do
  rsync -Lrh "/home/${targetuser}/$d" "${target}/home/${targetuser}/."
done
echo Trying to update packages at $target
sudo arch-chroot "$target" pacman -Syu --noconfirm
sudo arch-chroot "$target" chown -R "$targetuser" "/home/${targetuser}"
echo Umount $target
sudo umount -R "$target"

