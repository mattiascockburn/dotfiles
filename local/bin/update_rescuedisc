#!/bin/bash
target=${1:-/mnt/rescue}
root='/dev/disk/by-uuid/698c93c9-67e6-4a7c-ba9a-a5bc232394fc'
boot='/dev/disk/by-uuid/0B79-E3C8'
cache=/var/cache/pacman/pkg
declare -a dotfiles=(.config/git/ignore .gnupg .gitconfig .password-store .ssh .dotfiles)
targetuser=mattias
set -u

if [ ! -d "$target" ]; then
  echo $target is not a directory
  exit 1
fi
sudo mount "$root" "$target"
sudo mount "$boot" "${target}/boot"
sudo mount --bind "$cache" "${target}/${cache}"
if ! mount | grep -qc "$target"; then
  echo $target not mounted
  exit 1
fi
# update the most important dotfiles for recovery
echo Updating important stuff
for d in ${dotfiles[@]}; do
  rsync -Lrh "/home/${targetuser}/$d" "${target}/home/${targetuser}/."
done
echo Trying to update packages at $target
sudo arch-chroot "$target" pacman -Syu --noconfirm
sudo arch-chroot "$target" chown -R "$targetuser" "/home/${targetuser}"
echo Umount $target
sudo umount -R "$target"

